/*
 * This source file was generated by the Gradle 'init' task
 */
package org.oclinchoco;

import org.oclinchoco.property.NavTable;
import org.oclinchoco.source.PtrSource;
import org.oclinchoco.source.Source;

import org.chocosolver.solver.*;
import org.chocosolver.solver.variables.IntVar;
import org.chocosolver.util.tools.ArrayUtils;

import java.util.stream.IntStream;

public class ReferenceTable implements NavTable {
    int rows,cols,domain;
    int minCard, maxCard; boolean has_nulls;

    Model csp;
    IntVar[][] ptr_matrix;
    IntVar[][] occ_matrix;
    IntVar[] nullptrs;

    public ReferenceTable(CSP m, int n, int nn, int c, int d){
        csp = m.csp;
        rows=n; cols=nn; domain=d;
        minCard = c; maxCard=cols;
        has_nulls = !(minCard==maxCard);

        // Variables
        if (has_nulls) ptr_matrix = csp.intVarMatrix(rows, cols, 0,domain);
            else ptr_matrix = csp.intVarMatrix(rows, cols, 1,domain);
        occ_matrix = csp.intVarMatrix(rows, domain+1, 0, cols);
        
        // Constraints
        int[] values = IntStream.range(0, d+1).toArray();
        for(int i=0;i<n;i++) 
            csp.globalCardinality(ptr_matrix[i], values, occ_matrix[i], true).post();//ptr model = occ model

        // for(int i=0;i<rows;i++)for(int j=0;j<minCard;j++) csp.arithm(ptr_matrix[i][j],"!=",0).post(); //remove null ptr from the ptrs < minCard
        try{
            System.out.println("removing null pointer from variable domain");
            for(int i=0;i<rows;i++)for(int j=0;j<minCard;j++) ptr_matrix[i][j].updateLowerBound(1, null); //remove null ptr from the ptrs < minCard
        } catch(Exception e){System.out.println("Contradiction");}

        // NavTable Variables
        nullptrs = new IntVar[nn];
        for(int i=0;i<nn;i++) nullptrs[i] = m.nullptr;
    }

    // public static void Opposites(CSP m, ReferenceTable a, ReferenceTable b){
    //     int al = a.length;
    //     int bl = b.length;
    //     IntVar[][] aocc = m.intVarMatrix(al, bl, 0,magic);
    //     int[] avals = new int[bl];
    //     for(int i=0;i<bl;i++) avals[i]=(i);
    //     for(int i=0;i<al;i++){
    //         m.globalCardinality(a[i],avals,aocc[i],false).post();
    //     }
        
    //     IntVar[][] bocc = m.intVarMatrix(bl, al, 0,magic);
    //     int[] bvals = new int[al];
    //     for(int i=0;i<al;i++) bvals[i]=(i);
    //     for(int i=0;i<bl;i++){
    //         m.globalCardinality(b[i],bvals,bocc[i],false).post();
    //     }

    //     for(int i=0;i<al;i++) for(int j=0;j<bl;j++){
    //         m.ifOnlyIf(m.arithm(aocc[i][j], ">",0), m.arithm(bocc[j][i], ">",0));
    //     }
    // }

    @Override //NavTable
    public IntVar[] navTable(){
        return ArrayUtils.concat(nullptrs, ArrayUtils.flatten(ptr_matrix));
    }
    @Override //NavTable
    public int cols(){return cols;}
    
    @Override //NavTable
    public int lb(){ if(!has_nulls) return 1; return 0; }

    @Override //NavTable
    public int ub(){return domain;}

    class AdjList implements PtrSource {
        IntVar[] vars;
        private AdjList(IntVar[] vars){
            this.vars=vars;
        }
        @Override //PtrSource
        public IntVar[] pointers(){return vars;}
    }
    public AdjList adjList(int objId){
        return new AdjList(ptr_matrix[objId-1]);
    }


    
    public void loadData(int[][] data){
        for(int i=0;i<rows;i++) for(int j=0;j<cols;j++){
            csp.arithm(ptr_matrix[i][j], "=", data[i][j]).post();
        }
    }

    @Override
    public String toString() {
        String out = "";
        for(int i=0;i<rows;i++){
            for(int j=0;j<cols;j++){
                out += ptr_matrix[i][j] + ", ";
            }
            out += "\n";
        }
        return out;
    }
}